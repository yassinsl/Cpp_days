#include "ScalarConverter.hpp"

const char *ExceptionError::what() const throw()
{
  return VALIDITE_ARGS;
}

int IsPseudoLiteral(const string &s)
{
  return (s == "nan" || s == "nanf" ||
          s == "+inf" || s == "+inff" ||
          s == "-inf" || s == "-inff");
}

double GetPsudoLiteral(const string &s)
{
  double value = 0.0;

  if (s == "nan" || s == "nanf") value = 0.0 / 0.0;
  else if (s == "+inf" || s == "+inff") value = 1.0 / 0.0;
  else if (s == "-inf" || s == "-inff") value = -1.0 / 0.0;
  return value;
}

int Check_validite_argement(const string &literal, double *base, int &is_float)
{
  char *end = NULL;

  if (literal.size() == 3 && literal[0] == '\'' && literal[2] == '\'')
  {
    *base = static_cast<double>(literal[1]);
    return true;
  }
  errno = 0;
  *base = std::strtod(literal.c_str(), &end);
  if (IsPseudoLiteral(literal))
  {
    *base = GetPsudoLiteral(literal);
    if(literal == "+inff" || literal == "-inff") is_float = 1;
    return true;
  }
  if (end == literal.c_str() || errno == ERANGE)
    return false;
  if (*end == 'f')
  {
    if (std::strlen(end) > 1)
      return false;
    is_float = 1;
  }
  else if (*end != '\0')
    return false;
  return true;
}

int CPseudoLiteral(double &base)
{
  return (base != base || base == HUGE_VAL || base == -HUGE_VAL);
}

void print_char(double base)
{
  std::cout << "char: ";
  if (errno == ERANGE || CPseudoLiteral(base))
    printLn("Impossible", FAIL);
  else if (!std::isprint(static_cast<unsigned char>(static_cast<int>(base))))
    printLn("Non displayable", FAIL);
  else
    std::cout << "'" << static_cast<char>(base) << "'" << std::endl;
}

void print_int(double base)
{
  std::cout << "int: ";
  if (errno == ERANGE || CPseudoLiteral(base))
    printLn("Impossible", FAIL);
  else if (static_cast<long long>(base) > INT_MAX ||
           static_cast<long long>(base) < INT_MIN)
    printLn("Impossible", FAIL);
  else
    std::cout << static_cast<int>(base) << std::endl;
}
void PrintPseudoLiteral(double num, int is_float)
{
  if(num != num) std::cout << "nan";
  else if(num == HUGE_VAL) std::cout << "+inf"; 
  else if(num == -HUGE_VAL)  std::cout << "inf";
  if(is_float) std::cout << "f";
}
void print_number(double num, int is_float){
  if(CPseudoLiteral(num)) PrintPseudoLiteral(num, is_float);
  else if((long long) num == num)
        std::cout << num << ".00";
  else std::cout << static_cast<double>(num);
}
void print_float(double base, int is_float)
{
  std::cout << "float : ";
  print_number(base, is_float);
  if(is_float) std::cout << "f";
  std::cout << "\n";
}

void print_double(double base, int is_float)
{
  std::cout << "double : ";
  print_number(base, is_float);
  std::cout << "\n";
}

void print_convert(double base, int &is_float)
{
  print_char(base);
  print_int(base);
  print_float(base, is_float);
  print_double(base, is_float);
}

void ScalarConverter::convert(const string &literal)
{
  double base = 0.0;
  int is_float = 0;

  if (!Check_validite_argement(literal, &base, is_float))
    throw ExceptionError();
  print_convert(base, is_float);
}

int printLn(const std::string &msg, int status)
{
  std::cout << msg << std::endl;
  return status;
}

int main(int argc, char **av)
{
  if (argc != 2)
    return printLn(ERORR_ARC, FAIL);
  try
  {
    ScalarConverter::convert(av[1]);
    return printLn("Success convert", SUCCESS);
  }
  catch (std::exception &e)
  {
    return printLn(e.what(), FAIL);
  }
}
